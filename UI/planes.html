<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar Data</title>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f0f0;
    margin: 0;
    padding: 20px;
}
h1 {
    text-align: center;
}
#data-container {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
#data-table {
    width: 60%;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th, td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    text-align: left;
}
th {
    background-color: #f4f4f4;
}
tr:nth-child(even) {
    background-color: #f9f9f9;
}
#api-key-input {
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
}
#api-key-input input {
    padding: 5px;
    font-size: 16px;
}
#api-key-input button {
    padding: 5px 10px;
    font-size: 16px;
    margin-left: 10px;
}
#error-message {
    color: red;
    text-align: center;
}
#map {
    width: 35%;
    height: 600px;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
<h1>Radar Data</h1>
<div id="api-key-input">
<input type="text" id="apikey" placeholder="Enter your API Key">
<button onclick="saveApiKey()">Save API Key</button>
</div>
<div id="error-message"></div>
<div id="data-container">
    <div id="data-table">
        <!-- Data will be appended here -->
    </div>
    <div id="map"></div>
</div>

<script>
let map;
let markers = [];

document.addEventListener('DOMContentLoaded', () => {
    const storedApiKey = getCookieValue('apiKey');
    if (storedApiKey) {
        document.getElementById('apikey').value = storedApiKey; // Set input value to the stored API key
        initMap();
        fetchData(storedApiKey);
        setInterval(() => fetchData(storedApiKey), 5000); // Reload every 5 seconds
    }
});

function saveApiKey() {
    const apiKey = document.getElementById('apikey').value;
    if (apiKey) {
        document.cookie = `apiKey=${apiKey}; path=/; max-age=31536000`; // Store for 1 year
        if (!map) {
            initMap();
        }
        fetchData(apiKey);
        setInterval(() => fetchData(apiKey), 5000); // Reload every 5 seconds
    }
}

function getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function fetchData(apiKey) {
    fetch('/api/ListPlanes', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': apiKey
        }
    })
    .then(response => {
        if (response.status === 403) {
            throw new Error('Forbidden: Invalid API Key');
        }
        return response.json();
    })
    .then(data => {
        if (data.success === "true") {
            displayData(data.data);
            updateMap(data.data);
        }
    })
    .catch(error => {
        document.getElementById('error-message').textContent = error.message;
    });
}

function displayData(planeData) {
    const dataTableDiv = document.getElementById('data-table');
    let table = `<table>
        <thead>
        <tr>
            <th>Call Sign</th>
            <th>ICAO</th>
            <th>Altitude (ft)</th>
            <th>Speed (knots)</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Track (°)</th>
            <th>Vertical Rate</th>
        </tr>
        </thead>
        <tbody>`;
    planeData.forEach(plane => {
        table += `<tr>
            <td>${plane.CS != [] ? plane.CS : 'Unknown'}</td>
            <td>${plane.ICAO != [] ? plane.ICAO : 'Unknown'}</td>
            <td>${plane.alt != [] ? plane.alt : 0}</td>
            <td>${plane.speed != [] ? plane.speed.toFixed(2) : 0}</td>
            <td>${plane.lat != [] ? plane.lat.toFixed(5) : '0.00000'}</td>
            <td>${plane.lon != [] ? plane.lon.toFixed(5) : '0.00000'}</td>
            <td>${plane.track != [] ? plane.track.toFixed(2) : 0}</td>
            <td>${plane.vertrate != [] ? plane.vertrate : 0}</td>
        </tr>`;
    });
    table += `</tbody></table>`;
    dataTableDiv.innerHTML = table;
}

function initMap() {
    map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
}

function updateMap(planeData) {
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    planeData.forEach(plane => {
        if (plane.lat && plane.lon) {
            const marker = L.marker([plane.lat, plane.lon]).addTo(map);
            let popupContent = `<b>${plane.CS || 'Unknown'}</b><br>Altitude: ${plane.alt} ft<br>Speed: ${plane.speed} knots`;
            marker.bindPopup(popupContent);
            markers.push(marker);
        }
    });
}
</script>
</body>
</html>